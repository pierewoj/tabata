<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W67BZQFM');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabata Timer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .timer { font-size: 4rem; margin: 20px 0; }
        .exercise { font-size: 2rem; margin: 15px 0; }
        .info { font-size: 1.2rem; margin: 10px 0; opacity: 0.9; }
        
        .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover:not(:disabled) {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .start { background: #4CAF50; border-color: #4CAF50; }
        .stop { background: #f44336; border-color: #f44336; }
        .pause { background: #FF9800; border-color: #FF9800; }
        
        .config {
            display: none;
            text-align: left;
            margin-top: 20px;
        }
        
        .config.show { display: block; }
        
        .exercise-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        input {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: white;
            color: black;
        }
        
        .exercise-input { flex: 1; min-width: 150px; }
        .duration-input { width: 60px; text-align: center; }
        
        .move { 
            background: #2196F3; 
            border-color: #2196F3; 
            padding: 8px 12px; 
            font-size: 0.9rem;
            min-width: 40px;
        }
        
        .remove { 
            background: #f44336; 
            border-color: #f44336; 
            padding: 8px 12px; 
            font-size: 0.9rem;
        }
        
        @media (max-width: 600px) {
            .timer { font-size: 2.5rem; }
            .exercise { font-size: 1.5rem; }
            .container { padding: 20px; margin: 0 10px; }
            .exercise-item { flex-direction: column; align-items: stretch; }
            .exercise-input { min-width: auto; }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W67BZQFM"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="container">
        <h1>Tabata Timer</h1>
        
        <div id="timer-view">
            <div class="timer" id="timer">0:00</div>
            <div class="exercise" id="exercise-name">No exercises</div>
            <div class="info" id="phase">Press CONFIG button to define exercises</div>
            <div class="info" id="progress"></div>
            <div class="info" id="remaining-time"></div>
            
            <div class="button-row">
                <button id="start-btn" class="start" onclick="start()">START</button>
                <button id="resume-btn" class="start" onclick="start()" style="display:none">RESUME</button>
                <button id="pause-btn" class="pause" onclick="pause()" style="display:none">PAUSE</button>
                <button id="stop-btn" class="stop" onclick="stop()" style="display:none">STOP</button>
                <button id="config-btn" onclick="showConfig()">CONFIG</button>
                <button id="copy-btn" onclick="copyLink()">COPY LINK</button>
                <button id="prev-btn" onclick="prev()" style="display:none">← PREV</button>
                <button id="next-btn" onclick="next()" style="display:none">NEXT →</button>
            </div>
        </div>
        
        <div id="config-view" class="config">
            <h2>Configuration</h2>
            
            <div style="margin: 20px 0;">
                <label>Rest between exercises: </label>
                <input type="number" id="rest-input" min="0" max="60" value="5"> seconds
            </div>
            
            <div id="exercise-list"></div>
            
            <button onclick="addExercise()" style="background: #4CAF50; border-color: #4CAF50;">+ ADD EXERCISE</button>
            
            <div style="margin-top: 20px;">
                <button onclick="saveConfig()">SAVE</button>
                <button onclick="hideConfig()">CANCEL</button>
            </div>
        </div>
    </div>
    
    <footer style="text-align: center; margin-top: 30px; padding: 20px; opacity: 0.8;">
        <p>Free • No Ads • No Tracking • Open Source</p>
        <p>Created by <a href="https://github.com/pierewoj" target="_blank" style="color: #FFD700; text-decoration: none;">pierewoj</a></p>
    </footer>

    <script>
        let exercises = [];
        let currentIndex = 0;
        let timeLeft = 0;
        let isRunning = false;
        let isPaused = false;
        let isResting = false;
        let restTime = 5;
        let timer = null;
        let audioContext = null;
        let wakeLock = null;

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function calculateRemainingTime() {
            let total = 0;
            
            // Add remaining time for current exercise/rest
            total += timeLeft;
            
            // Add time for remaining exercises
            for (let i = currentIndex + (isResting ? 0 : 1); i < exercises.length; i++) {
                total += exercises[i].duration;
                if (i < exercises.length - 1) total += restTime; // Rest after each exercise except last
            }
            
            // If currently in exercise (not rest), add remaining rest periods
            if (!isResting && currentIndex < exercises.length - 1) {
                total += restTime;
            }
            
            return total;
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                // Wake lock not supported or failed
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        function beep(freq = 800) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain).connect(audioContext.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            osc.start();
            osc.stop(audioContext.currentTime + 0.2);
        }

        function updateDisplay() {
            const timerEl = document.getElementById('timer');
            const exerciseEl = document.getElementById('exercise-name');
            const phaseEl = document.getElementById('phase');
            const progressEl = document.getElementById('progress');
            const remainingEl = document.getElementById('remaining-time');

            if (exercises.length === 0) {
                timerEl.textContent = '0:00';
                exerciseEl.textContent = 'No exercises';
                phaseEl.textContent = 'Press CONFIG button to define exercises';
                progressEl.textContent = '';
                remainingEl.textContent = '';
                updateButtons();
                return;
            }

            timerEl.textContent = formatTime(timeLeft);
            
            if (isResting) {
                phaseEl.textContent = 'REST';
                exerciseEl.textContent = 'Get ready...';
                progressEl.textContent = `Next: ${exercises[currentIndex]?.name || ''}`;
            } else {
                if (isRunning) {
                    // Show next exercise name, or "FINAL EXERCISE" if it's the last one
                    if (currentIndex < exercises.length - 1) {
                        phaseEl.textContent = `Next: ${exercises[currentIndex + 1].name}`;
                    } else {
                        phaseEl.textContent = 'FINAL EXERCISE';
                    }
                } else {
                    phaseEl.textContent = 'READY';
                }
                exerciseEl.textContent = exercises[currentIndex]?.name || '';
                progressEl.textContent = `Exercise ${currentIndex + 1}/${exercises.length}`;
            }

            // Show remaining time
            if (isRunning || isPaused) {
                const remaining = calculateRemainingTime();
                remainingEl.textContent = `Remaining: ${formatTime(remaining)}`;
            } else {
                remainingEl.textContent = '';
            }

            updateButtons();
        }

        function updateButtons() {
            const startBtn = document.getElementById('start-btn');
            const resumeBtn = document.getElementById('resume-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const stopBtn = document.getElementById('stop-btn');
            const configBtn = document.getElementById('config-btn');
            const copyBtn = document.getElementById('copy-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            // Hide all buttons first
            startBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            stopBtn.style.display = 'none';
            configBtn.style.display = 'none';
            copyBtn.style.display = 'none';
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';

            if (exercises.length === 0) {
                // No exercises: show config and copy link
                configBtn.style.display = 'inline-block';
                copyBtn.style.display = 'inline-block';
            } else if (isRunning && !isPaused) {
                // Running: show pause, stop, prev, next
                pauseBtn.style.display = 'inline-block';
                stopBtn.style.display = 'inline-block';
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = 'inline-block';
            } else if (isPaused) {
                // Paused: show resume, stop, prev, next
                resumeBtn.style.display = 'inline-block';
                stopBtn.style.display = 'inline-block';
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = 'inline-block';
            } else {
                // Stopped: show start, config, copy link
                startBtn.style.display = 'inline-block';
                configBtn.style.display = 'inline-block';
                copyBtn.style.display = 'inline-block';
            }
        }

        function start() {
            if (exercises.length === 0) return alert('Add exercises first!');
            
            isRunning = true;
            isPaused = false;
            if (timeLeft === 0) {
                timeLeft = isResting ? restTime : exercises[currentIndex]?.duration || 60;
            }
            
            // Prevent screen from dimming on mobile
            requestWakeLock();
            
            timer = setInterval(() => {
                timeLeft--;
                updateDisplay();
                
                if (timeLeft <= 0) {
                    beep(isResting ? 800 : 400);
                    
                    if (isResting) {
                        isResting = false;
                        timeLeft = exercises[currentIndex].duration;
                    } else {
                        currentIndex++;
                        if (currentIndex >= exercises.length) {
                            alert('Workout complete!');
                            stop();
                            return;
                        }
                        isResting = true;
                        timeLeft = restTime;
                    }
                    updateDisplay();
                }
            }, 1000);
            
            beep();
            updateDisplay();
        }

        function pause() {
            isRunning = false;
            isPaused = true;
            if (timer) clearInterval(timer);
            updateDisplay();
        }

        function stop() {
            isRunning = false;
            isPaused = false;
            isResting = false;
            currentIndex = 0;
            timeLeft = exercises[0]?.duration || 0;
            if (timer) clearInterval(timer);
            
            // Allow screen to dim again
            releaseWakeLock();
            
            updateDisplay();
        }

        function prev() {
            if (currentIndex > 0) {
                currentIndex--;
                isResting = false;
                timeLeft = exercises[currentIndex].duration;
                updateDisplay();
            }
        }

        function next() {
            if (currentIndex < exercises.length - 1) {
                currentIndex++;
                isResting = false;
                timeLeft = exercises[currentIndex].duration;
                updateDisplay();
            }
        }

        function showConfig() {
            document.getElementById('timer-view').style.display = 'none';
            document.getElementById('config-view').classList.add('show');
            document.getElementById('rest-input').value = restTime;
            renderConfig();
        }

        function hideConfig() {
            document.getElementById('timer-view').style.display = 'block';
            document.getElementById('config-view').classList.remove('show');
        }

        function renderConfig() {
            const list = document.getElementById('exercise-list');
            list.innerHTML = '';
            
            exercises.forEach((ex, i) => {
                const div = document.createElement('div');
                div.className = 'exercise-item';
                div.innerHTML = `
                    <span>${i + 1}.</span>
                    <input type="text" class="exercise-input" value="${ex.name}" 
                           onchange="exercises[${i}].name = this.value">
                    <input type="number" class="duration-input" value="${ex.duration}" 
                           min="5" max="600" onchange="exercises[${i}].duration = parseInt(this.value) || 60">
                    <span>s</span>
                    <button class="move" onclick="moveUp(${i})" ${i === 0 ? 'disabled' : ''}>↑</button>
                    <button class="move" onclick="moveDown(${i})" ${i === exercises.length - 1 ? 'disabled' : ''}>↓</button>
                    <button class="remove" onclick="removeExercise(${i})">✖</button>
                `;
                list.appendChild(div);
            });
        }

        function addExercise() {
            exercises.push({ name: 'New Exercise', duration: 60 });
            renderConfig();
        }

        function removeExercise(index) {
            exercises.splice(index, 1);
            renderConfig();
        }

        function moveUp(index) {
            if (index > 0) {
                [exercises[index - 1], exercises[index]] = [exercises[index], exercises[index - 1]];
                renderConfig();
            }
        }

        function moveDown(index) {
            if (index < exercises.length - 1) {
                [exercises[index], exercises[index + 1]] = [exercises[index + 1], exercises[index]];
                renderConfig();
            }
        }

        function saveConfig() {
            restTime = parseInt(document.getElementById('rest-input').value) || 5;
            stop();
            updateUrl();
            hideConfig();
        }

        function copyLink() {
            if (exercises.length === 0) return alert('Add exercises first!');
            
            const config = { exercises, restTime };
            const url = window.location.origin + window.location.pathname + '#' + encodeURIComponent(JSON.stringify(config));
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link copied!');
                }).catch(() => {
                    prompt('Copy this link:', url);
                });
            } else {
                prompt('Copy this link:', url);
            }
        }

        function updateUrl() {
            // Skip URL updates in sandboxed environments
            try {
                if (exercises.length > 0 && window.location.protocol !== 'about:') {
                    const config = { exercises, restTime };
                    window.history.replaceState(null, '', '#' + encodeURIComponent(JSON.stringify(config)));
                }
            } catch (e) {
                // Silently fail in restricted environments
            }
        }

        function loadFromUrl() {
            try {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const config = JSON.parse(decodeURIComponent(hash));
                    if (config.exercises?.length) {
                        exercises = config.exercises;
                        restTime = config.restTime || 5;
                        return true;
                    }
                }
            } catch (e) {
                // Silently fail if URL parsing fails
            }
            return false;
        }

        // Initialize
        if (!loadFromUrl()) {
            exercises = [];
        }
        timeLeft = exercises[0]?.duration || 0;
        updateDisplay();
    </script>
</body>
</html>