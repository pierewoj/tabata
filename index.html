<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FBXB319QG8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FBXB319QG8');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabata Timer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .timer { font-size: 4rem; margin: 20px 0; }
        .exercise { font-size: 3.5rem; margin: 15px 0; font-weight: bold; line-height: 1.2; }
        .info { font-size: 1.2rem; margin: 10px 0; opacity: 0.9; }
        .next-exercise { font-size: 2.5rem; margin: 10px 0; font-weight: bold; color: #FFD700; }
        
        .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover:not(:disabled) {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .start { background: #4CAF50; border-color: #4CAF50; }
        .stop { background: #f44336; border-color: #f44336; }
        .pause { background: #FF9800; border-color: #FF9800; }
        
        .config {
            display: none;
            text-align: left;
            margin-top: 20px;
        }
        
        .config.show { display: block; }
        
        .exercise-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        input {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: white;
            color: black;
        }
        
        .exercise-input { flex: 1; min-width: 150px; }
        .duration-input { width: 60px; text-align: center; }
        
        .move { 
            background: #2196F3; 
            border-color: #2196F3; 
            padding: 8px 12px; 
            font-size: 0.9rem;
            min-width: 40px;
        }
        
        .remove { 
            background: #f44336; 
            border-color: #f44336; 
            padding: 8px 12px; 
            font-size: 0.9rem;
        }

        .audio-permission {
            background: rgba(255, 200, 0, 0.15);
            border: 2px solid rgba(255, 200, 0, 0.5);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }

        .audio-permission button {
            background: #FF9800;
            border-color: #FF9800;
            margin: 5px;
        }
        
        @media (max-width: 600px) {
            .timer { font-size: 2.5rem; }
            .exercise { font-size: 2.2rem; }
            .next-exercise { font-size: 1.8rem; }
            .container { padding: 20px; margin: 0 10px; }
            .exercise-item { flex-direction: column; align-items: stretch; }
            .exercise-input { min-width: auto; }
        }
        
        @media (max-width: 400px) {
            .exercise { font-size: 1.8rem; }
            .next-exercise { font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tabata Timer</h1>
        
        <div class="audio-permission" id="audio-permission">
            <p>üì¢ For the best experience with countdown sounds, please enable audio by tapping the button below. This allows sounds to work even when your phone is in silent mode.</p>
            <button onclick="enableAudio()">Enable Audio</button>
        </div>
        
        <div id="timer-view">
            <div class="timer" id="timer">0:00</div>
            <div class="exercise" id="exercise-name">No exercises</div>
            <div class="info" id="phase">Press CONFIG button to define exercises</div>
            <div class="info" id="progress"></div>
            <div class="info" id="remaining-time"></div>
            
            <div class="button-row">
                <button id="start-btn" class="start" onclick="start()">START</button>
                <button id="resume-btn" class="start" onclick="start()" style="display:none">RESUME</button>
                <button id="pause-btn" class="pause" onclick="pause()" style="display:none">PAUSE</button>
                <button id="stop-btn" class="stop" onclick="stop()" style="display:none">STOP</button>
                <button id="config-btn" onclick="showConfig()">CONFIG</button>
                <button id="copy-btn" onclick="copyLink()">COPY LINK</button>
                <button id="prev-btn" onclick="prev()" style="display:none">‚Üê PREV</button>
                <button id="next-btn" onclick="next()" style="display:none">NEXT ‚Üí</button>
            </div>
        </div>
        
        <div id="config-view" class="config">
            <h2>Configuration</h2>
            
            <div style="margin: 20px 0;">
                <label>Rest between exercises: </label>
                <input type="number" id="rest-input" min="0" max="60" value="5"> seconds
            </div>
            
            <div id="exercise-list"></div>
            
            <button onclick="addExercise()" style="background: #4CAF50; border-color: #4CAF50;">+ ADD EXERCISE</button>
            
            <div style="margin-top: 20px;">
                <button onclick="saveConfig()">SAVE</button>
                <button onclick="hideConfig()">CANCEL</button>
            </div>
        </div>
    </div>
    
    <footer style="text-align: center; margin-top: 30px; padding: 20px; opacity: 0.8;">
        <p>Free ‚Ä¢ No Ads ‚Ä¢ Open Source</p>
        <p>Created by <a href="https://github.com/pierewoj" target="_blank" style="color: #FFD700; text-decoration: none;">pierewoj</a></p>
    </footer>

    <script>
        let exercises = [];
        let currentIndex = 0;
        let timeLeft = 0;
        let isRunning = false;
        let isPaused = false;
        let isResting = false;
        let restTime = 5;
        let timer = null;
        let audioContext = null;
        let wakeLock = null;
        let audioEnabled = false;

        // Show audio permission notice on first load or if audio context is not working
        if (!localStorage.getItem('audioEnabled')) {
            document.getElementById('audio-permission').style.display = 'block';
        } else {
            audioEnabled = true;
            // Initialize audio context for returning users
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (err) {
                console.warn('Audio context creation failed:', err);
                // Show audio permission notice if audio context fails
                document.getElementById('audio-permission').style.display = 'block';
                audioEnabled = false;
            }
        }

        async function enableAudio() {
            try {
                // Create audio context with user gesture
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Play a silent sound to "unlock" audio on mobile
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain).connect(audioContext.destination);
                gain.gain.setValueAtTime(0, audioContext.currentTime);
                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
                
                audioEnabled = true;
                localStorage.setItem('audioEnabled', 'true');
                document.getElementById('audio-permission').style.display = 'none';
                
                // Test beep
                beep(800, 0.1);
            } catch (err) {
                console.warn('Audio initialization failed:', err);
            }
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function calculateTotalWorkoutTime() {
            if (exercises.length === 0) return 0;
            
            let total = 0;
            exercises.forEach((exercise, i) => {
                total += exercise.duration;
                if (i < exercises.length - 1) total += restTime;
            });
            return total;
        }

        function calculateRemainingTime() {
            let total = 0;
            
            total += timeLeft;
            
            for (let i = currentIndex + (isResting ? 0 : 1); i < exercises.length; i++) {
                total += exercises[i].duration;
                if (i < exercises.length - 1) total += restTime;
            }
            
            if (!isResting && currentIndex < exercises.length - 1) {
                total += restTime;
            }
            
            return total;
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                // Wake lock not supported or failed
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        function beep(freq = 800, duration = 0.2, volume = 0.3) {
            if (!audioEnabled) return;
            
            // Create audio context if it doesn't exist
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (err) {
                    console.warn('Audio context creation failed:', err);
                    return;
                }
            }
            
            try {
                // Resume audio context if suspended (important for mobile)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain).connect(audioContext.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(volume, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                osc.start();
                osc.stop(audioContext.currentTime + duration);
            } catch (err) {
                console.warn('Beep failed:', err);
                // If audio fails, show the permission notice again
                document.getElementById('audio-permission').style.display = 'block';
                audioEnabled = false;
            }
        }

        function playCountdownBeeps() {
            // Play 3 beeps with 1 second intervals: beep - 1s - beep - 1s - beep(higher/louder)
            beep(600, 0.2, 0.3);  // First beep
            setTimeout(() => beep(600, 0.2, 0.3), 1000);  // Second beep after 1 second
            setTimeout(() => beep(800, 0.2, 0.5), 2000);  // Third beep (higher/louder) after 2 seconds
        }

        function playWorkoutCompleteSound() {
            // Play a celebration sound sequence
            beep(800, 0.3, 0.5);
            setTimeout(() => beep(1000, 0.3, 0.5), 150);
            setTimeout(() => beep(1200, 0.3, 0.5), 300);
            setTimeout(() => beep(1000, 0.5, 0.5), 500);
        }

        function updateDisplay() {
            const timerEl = document.getElementById('timer');
            const exerciseEl = document.getElementById('exercise-name');
            const phaseEl = document.getElementById('phase');
            const progressEl = document.getElementById('progress');
            const remainingEl = document.getElementById('remaining-time');

            if (exercises.length === 0) {
                timerEl.textContent = '0:00';
                exerciseEl.textContent = 'No exercises';
                phaseEl.textContent = 'Press CONFIG button to define exercises';
                phaseEl.className = 'info';
                progressEl.textContent = '';
                progressEl.className = 'info';
                remainingEl.textContent = '';
                updateButtons();
                return;
            }

            timerEl.textContent = formatTime(timeLeft);
            
            if (isResting) {
                phaseEl.textContent = 'REST';
                phaseEl.className = 'next-exercise';
                exerciseEl.textContent = 'Get ready...';
                progressEl.textContent = `Next: ${exercises[currentIndex]?.name || ''}`;
                progressEl.className = 'next-exercise';
            } else {
                if (isRunning) {
                    if (currentIndex < exercises.length - 1) {
                        phaseEl.textContent = 'Next:';
                        phaseEl.className = 'next-exercise';
                        progressEl.textContent = exercises[currentIndex + 1].name;
                        progressEl.className = 'next-exercise';
                    } else {
                        phaseEl.textContent = 'FINAL EXERCISE';
                        phaseEl.className = 'next-exercise';
                        progressEl.textContent = `Exercise ${currentIndex + 1}/${exercises.length}`;
                        progressEl.className = 'info';
                    }
                } else {
                    phaseEl.textContent = 'READY';
                    phaseEl.className = 'info';
                    progressEl.textContent = `Exercise ${currentIndex + 1}/${exercises.length}`;
                    progressEl.className = 'info';
                }
                exerciseEl.textContent = exercises[currentIndex]?.name || '';
            }

            if (isRunning || isPaused) {
                const remaining = calculateRemainingTime();
                remainingEl.textContent = `Remaining: ${formatTime(remaining)}`;
            } else {
                const total = calculateTotalWorkoutTime();
                remainingEl.textContent = total > 0 ? `Total workout time: ${formatTime(total)}` : '';
            }

            updateButtons();
        }

        function updateButtons() {
            const startBtn = document.getElementById('start-btn');
            const resumeBtn = document.getElementById('resume-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const stopBtn = document.getElementById('stop-btn');
            const configBtn = document.getElementById('config-btn');
            const copyBtn = document.getElementById('copy-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            startBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            stopBtn.style.display = 'none';
            configBtn.style.display = 'none';
            copyBtn.style.display = 'none';
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';

            if (exercises.length === 0) {
                configBtn.style.display = 'inline-block';
                copyBtn.style.display = 'inline-block';
            } else if (isRunning && !isPaused) {
                pauseBtn.style.display = 'inline-block';
                stopBtn.style.display = 'inline-block';
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = 'inline-block';
            } else if (isPaused) {
                resumeBtn.style.display = 'inline-block';
                stopBtn.style.display = 'inline-block';
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                configBtn.style.display = 'inline-block';
                copyBtn.style.display = 'inline-block';
            }
        }

        function start() {
            if (exercises.length === 0) return alert('Add exercises first!');
            
            isRunning = true;
            isPaused = false;
            if (timeLeft === 0) {
                timeLeft = isResting ? restTime : exercises[currentIndex]?.duration || 60;
            }
            
            requestWakeLock();
            
            timer = setInterval(() => {
                // Play countdown beeps at 3 seconds remaining (only during exercise, not rest)
                if (!isResting && timeLeft === 3) {
                    playCountdownBeeps();
                }
                
                timeLeft--;
                updateDisplay();
                
                if (timeLeft <= 0) {
                    beep(isResting ? 800 : 400);
                    
                    if (isResting) {
                        isResting = false;
                        timeLeft = exercises[currentIndex].duration;
                    } else {
                        currentIndex++;
                        if (currentIndex >= exercises.length) {
                            playWorkoutCompleteSound();
                            alert('Workout complete! üéâ');
                            stop();
                            return;
                        }
                        isResting = true;
                        timeLeft = restTime;
                    }
                    updateDisplay();
                }
            }, 1000);
            
            beep();
            updateDisplay();
        }

        function pause() {
            isRunning = false;
            isPaused = true;
            if (timer) clearInterval(timer);
            updateDisplay();
        }

        function stop() {
            isRunning = false;
            isPaused = false;
            isResting = false;
            currentIndex = 0;
            timeLeft = exercises[0]?.duration || 0;
            if (timer) clearInterval(timer);
            
            releaseWakeLock();
            
            updateDisplay();
        }

        function prev() {
            if (currentIndex > 0) {
                currentIndex--;
                isResting = false;
                timeLeft = exercises[currentIndex].duration;
                updateDisplay();
            }
        }

        function next() {
            if (currentIndex < exercises.length - 1) {
                currentIndex++;
                isResting = false;
                timeLeft = exercises[currentIndex].duration;
                updateDisplay();
            }
        }

        function showConfig() {
            document.getElementById('timer-view').style.display = 'none';
            document.getElementById('config-view').classList.add('show');
            document.getElementById('rest-input').value = restTime;
            renderConfig();
        }

        function hideConfig() {
            document.getElementById('timer-view').style.display = 'block';
            document.getElementById('config-view').classList.remove('show');
        }

        function renderConfig() {
            const list = document.getElementById('exercise-list');
            list.innerHTML = '';
            
            exercises.forEach((ex, i) => {
                const div = document.createElement('div');
                div.className = 'exercise-item';
                div.innerHTML = `
                    <span>${i + 1}.</span>
                    <input type="text" class="exercise-input" value="${ex.name}" 
                           onchange="exercises[${i}].name = this.value">
                    <input type="number" class="duration-input" value="${ex.duration}" 
                           min="5" max="600" onchange="exercises[${i}].duration = parseInt(this.value) || 60">
                    <span>s</span>
                    <button class="move" onclick="moveUp(${i})" ${i === 0 ? 'disabled' : ''}>‚Üë</button>
                    <button class="move" onclick="moveDown(${i})" ${i === exercises.length - 1 ? 'disabled' : ''}>‚Üì</button>
                    <button class="remove" onclick="removeExercise(${i})">‚úñ</button>
                `;
                list.appendChild(div);
            });
        }

        function addExercise() {
            exercises.push({ name: 'New Exercise', duration: 60 });
            renderConfig();
        }

        function removeExercise(index) {
            exercises.splice(index, 1);
            renderConfig();
        }

        function moveUp(index) {
            if (index > 0) {
                [exercises[index - 1], exercises[index]] = [exercises[index], exercises[index - 1]];
                renderConfig();
            }
        }

        function moveDown(index) {
            if (index < exercises.length - 1) {
                [exercises[index], exercises[index + 1]] = [exercises[index + 1], exercises[index]];
                renderConfig();
            }
        }

        function saveConfig() {
            restTime = parseInt(document.getElementById('rest-input').value) || 5;
            stop();
            updateUrl();
            hideConfig();
        }

        function copyLink() {
            if (exercises.length === 0) return alert('Add exercises first!');
            
            const config = { exercises, restTime };
            const url = window.location.origin + window.location.pathname + '#' + encodeURIComponent(JSON.stringify(config));
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link copied!');
                }).catch(() => {
                    prompt('Copy this link:', url);
                });
            } else {
                prompt('Copy this link:', url);
            }
        }

        function updateUrl() {
            try {
                if (exercises.length > 0 && window.location.protocol !== 'about:') {
                    const config = { exercises, restTime };
                    window.history.replaceState(null, '', '#' + encodeURIComponent(JSON.stringify(config)));
                }
            } catch (e) {
                // Silently fail in restricted environments
            }
        }

        function loadFromUrl() {
            try {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const config = JSON.parse(decodeURIComponent(hash));
                    if (config.exercises?.length) {
                        exercises = config.exercises;
                        restTime = config.restTime || 5;
                        return true;
                    }
                }
            } catch (e) {
                // Silently fail if URL parsing fails
            }
            return false;
        }

        // Initialize
        if (!loadFromUrl()) {
            exercises = [];
        }
        timeLeft = exercises[0]?.duration || 0;
        updateDisplay();
    </script>
</body>
</html>